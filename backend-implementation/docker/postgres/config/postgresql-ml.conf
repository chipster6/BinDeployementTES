# ============================================================================
# POSTGRESQL CONFIGURATION FOR AI/ML WORKLOADS
# ============================================================================
#
# Enhanced PostgreSQL configuration optimized for AI/ML workloads
# Scaled for vector operations, ML training data, and high-performance queries
# Database-Architect + Performance-Optimization-Specialist coordination
#
# Created by: DevOps-Agent (MESH Coordination coord-ai-ml-mesh-001)
# Date: 2025-08-13
# Version: 1.0.0 - AI/ML Infrastructure Ready
# ============================================================================

# ============================================================================
# CONNECTION SETTINGS (ENHANCED FOR AI/ML)
# ============================================================================
listen_addresses = '*'
port = 5432

# Connection pool scaling: 120 â†’ 200 connections (Database-Architect requirement)
max_connections = 200
superuser_reserved_connections = 3

# Connection pooling optimization
tcp_keepalives_idle = 300
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# ============================================================================
# MEMORY SETTINGS (OPTIMIZED FOR ML WORKLOADS)
# ============================================================================
# Scaled memory allocation for AI/ML operations
shared_buffers = 512MB              # Enhanced from 256MB
effective_cache_size = 2GB          # Enhanced from 1GB
maintenance_work_mem = 128MB        # Enhanced from 64MB
work_mem = 32MB                     # Enhanced from 16MB (critical for ML queries)
temp_buffers = 16MB                 # Enhanced from 8MB

# Memory optimization for large datasets
max_stack_depth = 7MB
dynamic_shared_memory_type = posix
huge_pages = try

# ============================================================================
# WRITE AHEAD LOGGING (WAL) SETTINGS
# ============================================================================
wal_level = replica
max_wal_size = 2GB                  # Enhanced from 1GB
min_wal_size = 160MB                # Enhanced from 80MB
checkpoint_completion_target = 0.9   # Enhanced from 0.7
checkpoint_timeout = 10min          # Enhanced from 5min
wal_compression = on
wal_buffers = 16MB

# WAL archiving for ML data safety
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'

# ============================================================================
# QUERY PERFORMANCE (ML-OPTIMIZED)
# ============================================================================
# Enhanced for spatial and ML queries
effective_io_concurrency = 300      # Enhanced from 200
random_page_cost = 1.0              # Enhanced from 1.1 (SSD optimization)
seq_page_cost = 1.0
default_statistics_target = 500     # Enhanced from 100 (better ML query planning)

# Cost-based optimization for ML workloads
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# ============================================================================
# PARALLEL QUERY SETTINGS (ENHANCED FOR ML)
# ============================================================================
# Optimized for ML data processing
max_parallel_workers_per_gather = 4  # Enhanced from 2
max_parallel_workers = 16            # Enhanced from 8
max_parallel_maintenance_workers = 4  # Enhanced from 2
parallel_setup_cost = 1000
parallel_tuple_cost = 0.1
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512kB
force_parallel_mode = off

# ============================================================================
# ML-SPECIFIC QUERY OPTIMIZATIONS
# ============================================================================
# Enable JIT compilation for complex ML queries
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# Hash table optimizations for ML joins
hash_mem_multiplier = 2.0
max_parallel_maintenance_workers = 4

# ============================================================================
# LOGGING SETTINGS (ENHANCED FOR ML MONITORING)
# ============================================================================
log_destination = 'stderr'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-ml-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 50MB            # Enhanced from 10MB

# Enhanced logging for ML query analysis
log_min_duration_statement = 50ms   # Enhanced from 100ms
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,client=%h app=%a '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 5MB               # Enhanced from 10MB
log_autovacuum_min_duration = 0
log_error_verbosity = verbose

# ML-specific logging
log_statement = 'ddl'              # Log ML schema changes
log_duration = on
log_hostname = on
log_line_prefix = '%t [%p] %q%u@%d/%h '

# ============================================================================
# AUTOVACUUM SETTINGS (CRITICAL FOR ML PERFORMANCE)
# ============================================================================
# Enhanced autovacuum for ML data tables
autovacuum = on
autovacuum_max_workers = 6          # Enhanced from 3
autovacuum_naptime = 30s            # Enhanced from 1min
autovacuum_vacuum_threshold = 25    # Enhanced from 50
autovacuum_analyze_threshold = 25   # Enhanced from 50
autovacuum_vacuum_scale_factor = 0.05  # Enhanced from 0.1
autovacuum_analyze_scale_factor = 0.02 # Enhanced from 0.05

# Vacuum cost delay optimization
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000 # Enhanced from default
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20

# ============================================================================
# POSTGIS AND SPATIAL OPTIMIZATION
# ============================================================================
shared_preload_libraries = 'postgis-3,pg_stat_statements,auto_explain'
max_locks_per_transaction = 512     # Enhanced from 256 (for complex spatial queries)

# Spatial query optimization
enable_seqscan = on
enable_indexscan = on
enable_bitmapscan = on
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# ============================================================================
# ML-SPECIFIC EXTENSIONS AND SETTINGS
# ============================================================================
# Statistics collection for ML query optimization
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 4096    # Enhanced from default

# Query planning for ML workloads
from_collapse_limit = 12            # Enhanced from 8
join_collapse_limit = 12            # Enhanced from 8
geqo = on
geqo_threshold = 15                 # Enhanced from 12
geqo_effort = 10                    # Maximum effort for ML queries
geqo_pool_size = 200               # Enhanced pool size
geqo_generations = 2000            # Enhanced generations

# ============================================================================
# SECURITY SETTINGS (SECURITY-AGENT COORDINATION)
# ============================================================================
ssl = off                          # Enable in production
password_encryption = scram-sha-256
row_security = on
shared_preload_libraries = 'postgis-3,pg_stat_statements,auto_explain,auth_delay'

# Enhanced authentication
auth_delay.milliseconds = 500

# ============================================================================
# BACKUP AND RECOVERY SETTINGS
# ============================================================================
# Enhanced backup configuration for ML data
archive_mode = on
archive_timeout = 300s
wal_keep_size = 1GB
max_wal_senders = 3
hot_standby = on
hot_standby_feedback = on

# ============================================================================
# PERFORMANCE MONITORING AND ANALYSIS
# ============================================================================
# Enable query analysis for ML optimization
auto_explain.log_min_duration = 100ms
auto_explain.log_analyze = on
auto_explain.log_verbose = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_triggers = on
auto_explain.log_nested_statements = on

# Statement statistics for ML query optimization
pg_stat_statements.max = 10000      # Enhanced from default
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# ============================================================================
# LOCALE AND TIME SETTINGS
# ============================================================================
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'

# ============================================================================
# TIMEOUT SETTINGS (OPTIMIZED FOR ML WORKLOADS)
# ============================================================================
# Enhanced timeouts for ML operations
statement_timeout = 60min          # Enhanced from 30min
lock_timeout = 2min                # Enhanced from 30s
idle_in_transaction_session_timeout = 2h  # Enhanced from 60min
tcp_user_timeout = 30s

# Connection timeouts
authentication_timeout = 60s
deadlock_timeout = 5s

# ============================================================================
# DEVELOPMENT AND DEBUGGING (DISABLE IN PRODUCTION)
# ============================================================================
# Enhanced debugging for ML development
log_statement = 'mod'
log_min_error_statement = 'warning' # Enhanced from 'error'
debug_print_plan = off
debug_print_parse = off
debug_print_rewritten = off
debug_pretty_print = on

# ============================================================================
# RESOURCE LIMITS AND QUOTAS
# ============================================================================
# Enhanced resource management
max_files_per_process = 2000        # Enhanced from 1000
max_pred_locks_per_transaction = 128 # Enhanced from 64
max_pred_locks_per_relation = 2048   # Enhanced from default
max_pred_locks_per_page = 8         # Enhanced from 2

# Memory limits for ML operations
temp_file_limit = 20GB              # Enhanced limit for ML temp files
log_temp_files = 100MB              # Log large temp files

# ============================================================================
# AI/ML SPECIFIC OPTIMIZATIONS
# ============================================================================
# Vector and array optimizations
array_nulls = on
default_with_oids = off

# Enhanced constraint checking for ML data integrity
check_function_bodies = on
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off

# ============================================================================
# MONITORING AND ALERTING
# ============================================================================
# Enhanced monitoring for ML workloads
log_checkpoints = on
log_lock_waits = on
log_recovery_conflict_waits = on
log_parameter_max_length = 4096     # Enhanced for ML query logging
log_parameter_max_length_on_error = 4096

# Performance insights
track_commit_timestamp = on
compute_query_id = on

# ============================================================================
# ADVANCED ML-SPECIFIC CONFIGURATIONS
# ============================================================================
# Enhanced for time-series and analytical workloads
enable_partitionwise_join = on
enable_partitionwise_aggregate = on
plan_cache_mode = auto
constraint_exclusion = partition

# JSONB optimization for ML metadata
gin_fuzzy_search_limit = 0
gin_pending_list_limit = 8MB        # Enhanced from 4MB